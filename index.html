<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Analysis Assistant System</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body { font-family: 'Prompt', sans-serif; background:#f8fafc; }
.hidden { display:none; }
</style>
</head>

<body class="min-h-screen">

<header class="bg-white shadow px-4 py-3 font-bold flex justify-between">
  <div>CAAS AI</div>
  <button onclick="location.reload()"><i class="fa-solid fa-power-off"></i></button>
</header>

<main class="max-w-3xl mx-auto p-4 space-y-6">

<!-- INPUT -->
<section id="view-input" class="space-y-4">
  <input id="custName" class="border p-2 w-full" placeholder="ชื่อลูกค้า">
  <input id="custAge" type="number" class="border p-2 w-full" placeholder="อายุ">
  <input id="custIncome" type="number" class="border p-2 w-full" placeholder="รายได้ต่อเดือน">

  <!-- ตัวอย่าง field เดิม (ไม่ตัด) -->
  <input id="custJob" class="border p-2 w-full" placeholder="อาชีพ">
  <input id="saving" type="number" class="border p-2 w-full" placeholder="เงินฝาก">
  <input id="fund" type="number" class="border p-2 w-full" placeholder="กองทุนรวม">
  <input id="family" class="border p-2 w-full" placeholder="ภาระครอบครัว">
  <textarea id="insurance" class="border p-2 w-full" placeholder="ประกันที่มีอยู่"></textarea>

  <button onclick="startAnalysis()" class="bg-blue-600 text-white w-full py-3 rounded">
    วิเคราะห์ด้วย AI
  </button>
</section>

<!-- LOADING -->
<section id="view-processing" class="hidden fixed inset-0 bg-white/80 flex items-center justify-center">
  <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600"></i>
</section>

<!-- RESULT -->
<section id="view-result" class="hidden space-y-4">
  <h2 id="res-name" class="text-xl font-bold"></h2>
  <p id="res-meta"></p>

  <div id="recommendation-list" class="space-y-2"></div>

  <button onclick="generatePDF()" class="bg-slate-800 text-white px-4 py-2 rounded">
    Export PDF
  </button>
</section>

</main>

<script>
/* ===== STATE ===== */
const appState = {
  cust: null,
  aiResult: []
};

/* ===== DATA ===== */
function gatherCustomerData(){
  return {
    name: custName.value.trim(),
    age: Number(custAge.value),
    income: Number(custIncome.value),
    job: custJob.value,
    saving: Number(saving.value),
    fund: Number(fund.value),
    family: family.value,
    insurance: insurance.value
  };
}

/* ===== PROMPT ===== */
function buildAIPrompt(data){
  return `
คุณคือที่ปรึกษาทางการเงิน
ข้อมูลลูกค้า:
ชื่อ: ${data.name}
อายุ: ${data.age}
รายได้: ${data.income}
อาชีพ: ${data.job}
เงินฝาก: ${data.saving}
กองทุน: ${data.fund}
ครอบครัว: ${data.family}
ประกันที่มี: ${data.insurance}

ช่วยวิเคราะห์และแนะนำประกันที่เหมาะสม
ตอบเป็น bullet สั้น ๆ ชัดเจน
`;
}

/* ===== AI CALL (Supabase Edge Function) ===== */
async function analyzeWithGemini(inputData){
  const res = await fetch(
    "https://uvlyxomlvdlemobvquku.supabase.co/functions/v1/smooth-endpoint",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2bHl4b21sdmRsZW1vYnZxdWt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNjgzOTEsImV4cCI6MjA4Mzg0NDM5MX0.IqG4yFU8T_gNl1vZ9Cl6iiCX8na06y_qSWeopg3guSA"
      },
      body: JSON.stringify({
        prompt: buildAIPrompt(inputData)
      })
    }
  );

  if(!res.ok) throw new Error("Edge Function Error");
  return await res.json();
}

/* ===== MAIN ===== */
async function startAnalysis(){
  if(!custName.value || !custAge.value || !custIncome.value){
    Swal.fire('ข้อมูลไม่ครบ','กรุณากรอกข้อมูลหลักให้ครบ','warning');
    return;
  }

  document.getElementById('view-processing').classList.remove('hidden');

  try{
    const data = gatherCustomerData();
    appState.cust = data;

    const ai = await analyzeWithGemini(data);
    appState.aiResult = ai.recommendations || [];

  } catch {
    appState.aiResult = ['ไม่สามารถวิเคราะห์ AI ได้ในขณะนี้'];
  }

  renderResult();
  document.getElementById('view-processing').classList.add('hidden');
  document.getElementById('view-result').classList.remove('hidden');
}

/* ===== RENDER ===== */
function renderResult(){
  res-name.innerText = appState.cust.name;
  res-meta.innerText = `อายุ ${appState.cust.age} ปี | รายได้ ${appState.cust.income.toLocaleString()} บาท`;

  recommendation-list.innerHTML = '';
  appState.aiResult.forEach(r=>{
    recommendation-list.innerHTML += `<div class="p-3 bg-slate-100 rounded">${r}</div>`;
  });
}

/* ===== PDF ===== */
function generatePDF(){
  html2pdf().from(document.getElementById('view-result')).set({
    filename:`CAAS_${appState.cust.name}.pdf`,
    html2canvas:{scale:2}
  }).save();
}
</script>

</body>
</html>
